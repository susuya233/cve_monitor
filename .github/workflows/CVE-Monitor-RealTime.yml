name: CVE-Monitor-RealTime

# 每小时运行一次（UTC时间每小时5分，北京时间每小时13分）
on:
  schedule:
    - cron: '5 * * * *'  # 每小时运行一次
  workflow_dispatch:
    inputs:
      no_push_switch:
        description: '是否关闭推送功能'
        required: true
        default: 'OFF'
        type: choice
        options:
          - 'ON'
          - 'OFF'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 短时间运行，提高效率
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ./requirements.txt

      - name: Run CVE Monitor RealTime Push
        env:
          # 推送相关的敏感信息
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          DINGDING_SECRET: ${{ secrets.DINGDING_SECRET }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          DISCARD_WEBHOOK: ${{ secrets.DISCARD_WEBHOOK }}
          DISCARD_SEND_NORMAL_MSG: ${{ secrets.DISCARD_SEND_NORMAL_MSG || 'ON' }}
          DISCARD_SEND_DAILY_REPORT: ${{ secrets.DISCARD_SEND_DAILY_REPORT || 'ON' }}
          # 控制开关
          DAILY_REPORT_SWITCH: 'OFF'  # 关闭日报生成
          WEEKLY_REPORT_SWITCH: 'OFF'  # 关闭周报生成
          NO_PUSH_SWITCH: ${{ github.event.inputs.no_push_switch || secrets.NO_PUSH_SWITCH || 'OFF' }}  # 开启推送
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 单次执行，只推送新漏洞，不生成日报/周报
          python ./CVE_monitor.py --once

      - name: Commit database changes
        run: |
          git diff
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add data.db  # 只提交数据库，不提交其他文件
          git commit -m "实时推送更新数据库（`date +'%Y-%m-%d %H:%M:%S'`）" || echo "没有新内容需要提交"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}